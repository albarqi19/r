<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">تحفيظ الشرقية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#494776',
                        secondary: '#4F9DA6',
                        custom: '#323266',
                        accent: '#7DCCE5'
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./assets/css/main.css">
    <style>
        body {
            font-family: 'IBM Plex Sans Arabic', sans-serif;
        }
        .title-font {
            font-family: 'IBM Plex Sans Arabic', sans-serif;
        }
        .social-icon {
            transition: all 0.3s ease;
        }
        .social-icon:hover {
            transform: translateY(-8px) scale(1.1);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }
        .social-icon:active {
            transform: translateY(-4px) scale(1.05);
        }
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, transparent 37%, #f0f0f0 63%);
            background-size: 400% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
        }
        @keyframes shimmer {
            0% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-center p-4 sm:p-6">
    
    <!-- Loading State -->
    <div id="loadingState" class="w-full max-w-xs sm:max-w-sm mx-auto px-4 sm:px-0">
        <div class="text-center mb-8 sm:mb-12">
            <div class="loading-skeleton w-24 h-24 sm:w-32 sm:h-32 mx-auto rounded-2xl mb-6 sm:mb-8"></div>
            <div class="loading-skeleton w-32 h-6 mx-auto rounded-lg"></div>
        </div>
        <div class="grid grid-cols-2 gap-4 sm:gap-6 mb-8 sm:mb-12">
            <div class="loading-skeleton rounded-2xl sm:rounded-3xl min-h-[80px] sm:min-h-[100px]"></div>
            <div class="loading-skeleton rounded-2xl sm:rounded-3xl min-h-[80px] sm:min-h-[100px]"></div>
            <div class="loading-skeleton rounded-2xl sm:rounded-3xl min-h-[80px] sm:min-h-[100px]"></div>
            <div class="loading-skeleton rounded-2xl sm:rounded-3xl min-h-[80px] sm:min-h-[100px]"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div id="mainContent" class="w-full max-w-xs sm:max-w-sm mx-auto px-4 sm:px-0 hidden">
        
        <!-- Header Section -->
        <div class="text-center mb-8 sm:mb-12">
            <!-- Logo -->
            <div class="mb-6 sm:mb-8">
                <img src="./Logo.png" alt="تحفيظ الشرقية" class="w-24 h-24 sm:w-32 sm:h-32 mx-auto object-contain">
            </div>
            
            <!-- Branch Info -->
            <p id="branchName" class="text-primary text-base sm:text-lg font-semibold px-2">جاري التحميل...</p>
        </div>

        <!-- Social Icons Grid -->
        <div class="grid grid-cols-2 gap-4 sm:gap-6 mb-8 sm:mb-12" id="socialGrid">
            <!-- Icons will be generated dynamically -->
        </div>

        <!-- Action Buttons -->
        <div class="text-center mb-6 sm:mb-8">
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center items-center">
                <!-- Online Store Button -->
                <button id="storeBtn" class="bg-primary hover:bg-opacity-80 text-white font-semibold py-3 px-6 sm:py-4 sm:px-8 rounded-xl sm:rounded-2xl shadow-lg transform transition-all duration-300 hover:scale-105 hover:shadow-xl flex items-center justify-center gap-2 sm:gap-3 text-sm sm:text-base w-full sm:w-auto">
                    <i class="fas fa-shopping-cart text-lg sm:text-xl"></i>
                    <span>المتجر الإلكتروني</span>
                </button>
                
                <!-- Share Button -->
                <button id="shareBtn" class="bg-custom hover:bg-opacity-80 text-white font-semibold py-3 px-6 sm:py-4 sm:px-8 rounded-xl sm:rounded-2xl shadow-lg transform transition-all duration-300 hover:scale-105 hover:shadow-xl flex items-center justify-center gap-2 sm:gap-3 text-sm sm:text-base w-full sm:w-auto">
                    <i class="fas fa-share-alt text-lg sm:text-xl"></i>
                    <span>مشاركة الصفحة</span>
                </button>
            </div>
        </div>

        <!-- Additional Info -->
        <div class="text-center">
            <div class="w-16 h-0.5 bg-gradient-to-r from-transparent via-primary to-transparent mx-auto mb-4"></div>
            <p class="text-gray-400 text-xs">© ٢٠٢٤ تحفيظ الشرقية</p>
        </div>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden text-center">
        <div class="bg-red-50 border border-red-200 rounded-2xl p-6 max-w-md mx-auto">
            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
            <h3 class="text-red-800 font-bold text-lg mb-2">فرع غير موجود</h3>
            <p class="text-red-600 mb-4">لم يتم العثور على الفرع المطلوب</p>
            <a href="./home.html" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl transition-colors inline-flex items-center gap-2">
                <i class="fas fa-home"></i>
                <span>العودة للرئيسية</span>
            </a>
        </div>
    </div>

    <script src="./assets/js/supabase-service.js"></script>
    <script>
        class BranchPageManager {
            constructor() {
                this.branchId = this.getBranchIdFromURL();
                this.branchData = null;
                this.init();
            }

            getBranchIdFromURL() {
                // استخراج معرف الفرع من URL
                const urlParams = new URLSearchParams(window.location.search);
                const fromParam = urlParams.get('branch');
                
                if (fromParam) {
                    return fromParam;
                }

                // استخراج من المسار
                const pathSegments = window.location.pathname.split('/').filter(segment => segment);
                const lastSegment = pathSegments[pathSegments.length - 1];
                
                // إزالة .html إن وجد
                return lastSegment.replace('.html', '');
            }

            async init() {
                try {
                    console.log('🚀 بدء تهيئة صفحة الفرع...');
                    console.log('📍 معرف الفرع:', this.branchId);
                    
                    // إعطاء وقت أكبر لتحميل البيانات
                    await this.loadBranchData();
                    
                    if (this.branchData) {
                        console.log('✅ تم تحميل البيانات بنجاح، بدء عرض الصفحة...');
                        this.renderBranchPage();
                        this.setupEventListeners();
                        this.showContent();
                    } else {
                        console.error('❌ فشل في تحميل البيانات، عرض صفحة الخطأ...');
                        // إعطاء محاولة أخيرة بعد 3 ثوان
                        console.log('🔄 محاولة أخيرة بعد 3 ثوان...');
                        setTimeout(async () => {
                            await this.loadBranchData();
                            if (this.branchData) {
                                this.renderBranchPage();
                                this.setupEventListeners();
                                this.showContent();
                            } else {
                                this.showError();
                            }
                        }, 3000);
                    }
                } catch (error) {
                    console.error('❌ خطأ في تحميل بيانات الفرع:', error);
                    this.showError();
                }
            }

            async loadBranchData() {
                try {
                    console.log('🔄 بدء جلب بيانات الفرع من Supabase:', this.branchId);
                    console.log('📍 URL الحالي:', window.location.href);
                    
                    // انتظار تحميل خدمة Supabase مع وقت أطول
                    let attempts = 0;
                    while (!window.supabaseService && attempts < 100) { // زيادة المحاولات إلى 100
                        console.log(`⏳ محاولة ${attempts + 1}: انتظار تحميل supabaseService...`);
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }
                    
                    if (!window.supabaseService) {
                        console.error('❌ خدمة Supabase غير متوفرة بعد 10 ثوانِ');
                        console.error('❌ window.supabaseService:', window.supabaseService);
                        console.error('❌ window object keys:', Object.keys(window));
                        return false;
                    }
                    
                    if (!window.supabaseService.getBranch) {
                        console.error('❌ دالة getBranch غير متوفرة');
                        console.error('❌ المتاح في supabaseService:', Object.keys(window.supabaseService));
                        return false;
                    }
                    
                    console.log('✅ خدمة Supabase متوفرة ودالة getBranch موجودة');
                    
                    // جلب بيانات الفرع من قاعدة البيانات
                    console.log('🔍 استدعاء getBranch للفرع:', this.branchId);
                    const result = await window.supabaseService.getBranch(this.branchId);
                    console.log('📊 نتيجة جلب البيانات:', result);
                    
                    if (result.success && result.data) {
                        this.branchData = result.data;
                        console.log('✅ تم تحميل بيانات الفرع من قاعدة البيانات:', this.branchData.name || this.branchData.branch_name);
                        console.log('📋 البيانات المحملة:', this.branchData);
                        return true;
                    } else {
                        console.error('❌ لم يتم العثور على الفرع في قاعدة البيانات:', this.branchId);
                        console.error('❌ تفاصيل النتيجة:', result);
                        
                        // جرب معرفات أخرى محتملة
                        console.log('🔄 محاولة البحث بمعرفات أخرى...');
                        const alternativeIds = ['al-khobar', 'alkhobar', 'khobar'];
                        for (const altId of alternativeIds) {
                            if (altId !== this.branchId) {
                                console.log(`🔍 جرب معرف بديل: ${altId}`);
                                const altResult = await window.supabaseService.getBranch(altId);
                                if (altResult.success && altResult.data) {
                                    console.log('✅ تم العثور على الفرع بمعرف بديل:', altId);
                                    this.branchData = altResult.data;
                                    return true;
                                }
                            }
                        }
                        return false;
                    }
                    
                } catch (error) {
                    console.error('❌ خطأ في جلب بيانات الفرع من قاعدة البيانات:', error);
                    console.error('❌ تفاصيل الخطأ:', error.stack);
                    return false;
                }
            }

            renderBranchPage() {
                console.log('🎨 بدء عرض صفحة الفرع...');
                console.log('📋 البيانات المستخدمة في العرض:', this.branchData);
                
                // تحديث عنوان الصفحة
                const pageTitle = document.getElementById('pageTitle');
                if (pageTitle) {
                    pageTitle.textContent = `تحفيظ الشرقية - ${this.branchData.name || this.branchData.branch_name || 'فرع غير محدد'}`;
                    console.log('✅ تم تحديث عنوان الصفحة:', pageTitle.textContent);
                } else {
                    console.error('❌ لم يتم العثور على عنصر pageTitle');
                }
                
                // تحديث اسم الفرع
                const branchName = document.getElementById('branchName');
                if (branchName) {
                    branchName.textContent = this.branchData.name || this.branchData.branch_name || 'فرع غير محدد';
                    console.log('✅ تم تحديث اسم الفرع:', branchName.textContent);
                } else {
                    console.error('❌ لم يتم العثور على عنصر branchName');
                }

                // إنشاء أيقونات التواصل الاجتماعي
                console.log('🔗 بدء إنشاء أيقونات التواصل...');
                this.renderSocialIcons();
                console.log('✅ انتهاء عرض صفحة الفرع');
            }

            renderSocialIcons() {
                const socialGrid = document.getElementById('socialGrid');
                socialGrid.innerHTML = '';

                // التحقق من صحة الحقول قبل العرض
                function isValidField(value) {
                    return value && value.trim() !== '' && value !== 'null' && value !== null;
                }

                const socialPlatforms = [
                    {
                        name: 'twitter',
                        icon: 'fab fa-twitter',
                        url: isValidField(this.branchData.twitter) ? this.branchData.twitter : null,
                        color: 'text-white'
                    },
                    {
                        name: 'whatsapp',
                        icon: 'fab fa-whatsapp',
                        url: isValidField(this.branchData.whatsapp) ? `https://wa.me/${this.branchData.whatsapp.replace(/[^\d]/g, '')}` : null,
                        color: 'text-white'
                    },
                    {
                        name: 'instagram',
                        icon: 'fab fa-instagram',
                        url: isValidField(this.branchData.instagram) ? this.branchData.instagram : null,
                        color: 'text-white'
                    },
                    {
                        name: 'location',
                        icon: 'fas fa-map-marker-alt',
                        url: isValidField(this.branchData.location) ? this.branchData.location : null,
                        color: 'text-white'
                    }
                ];

                // إظهار فقط الأيقونات المتوفرة
                const availablePlatforms = socialPlatforms.filter(platform => platform.url);
                console.log('🔗 المنصات المتوفرة:', availablePlatforms.map(p => p.name));

                availablePlatforms.forEach((platform, index) => {
                    if (platform.url) {
                        const iconElement = this.createSocialIcon(platform, index);
                        socialGrid.appendChild(iconElement);
                    }
                });
                
                if (availablePlatforms.length === 0) {
                    console.log('⚠️ لا توجد روابط متوفرة للعرض');
                }
            }

            createSocialIcon(platform, index) {
                const link = document.createElement('a');
                link.href = platform.url;
                link.target = '_blank';
                link.className = 'social-icon bg-custom rounded-2xl sm:rounded-3xl p-4 sm:p-6 flex items-center justify-center aspect-square shadow-lg min-h-[80px] sm:min-h-[100px] opacity-0';
                link.style.animationDelay = `${index * 100 + 500}ms`;
                
                link.innerHTML = `<i class="${platform.icon} ${platform.color} text-3xl sm:text-5xl"></i>`;
                
                // إضافة تأثير النقر
                link.addEventListener('click', (e) => {
                    this.handleSocialClick(platform.name, e);
                });

                // تشغيل الأنيميشن
                setTimeout(() => {
                    link.style.opacity = '1';
                    link.style.animation = 'fadeInUp 0.6s ease forwards';
                }, index * 100 + 500);

                return link;
            }

            handleSocialClick(platform, e) {
                console.log(`تم النقر على ${platform}`);
                
                // إحصائيات استخدام (يمكن إرسالها لـ Firebase Analytics لاحقاً)
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'social_click', {
                        'social_platform': platform,
                        'branch_id': this.branchId
                    });
                }
            }

            setupEventListeners() {
                // زر المتجر الإلكتروني - معطل حالياً
                document.getElementById('storeBtn').addEventListener('click', () => {
                    this.showComingSoon('storeBtn', 'المتجر الإلكتروني قريباً جداً!');
                });

                // زر المشاركة
                document.getElementById('shareBtn').addEventListener('click', () => {
                    this.handleShare();
                });
            }

            async handleShare() {
                const shareData = {
                    title: `تحفيظ الشرقية - ${this.branchData.name || this.branchData.branch_name || 'فرع غير محدد'}`,
                    text: `روابط التواصل مع تحفيظ الشرقية - ${this.branchData.name || this.branchData.branch_name || 'فرع غير محدد'}`,
                    url: window.location.href
                };

                try {
                    if (navigator.share && navigator.canShare(shareData)) {
                        await navigator.share(shareData);
                        console.log('تم المشاركة بنجاح');
                    } else {
                        await navigator.clipboard.writeText(window.location.href);
                        this.showSuccess('shareBtn', 'تم نسخ الرابط!');
                    }
                } catch (err) {
                    console.log('خطأ في المشاركة:', err);
                    this.showFallbackShare();
                }
            }

            showFallbackShare() {
                const shareText = `تحفيظ الشرقية - ${this.branchData.name || this.branchData.branch_name || 'فرع غير محدد'}\n${window.location.href}`;
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
                const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`;
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl p-6 max-w-sm w-full">
                        <h3 class="text-lg font-bold text-primary mb-4 text-center">مشاركة الصفحة</h3>
                        <div class="space-y-3">
                            <a href="${whatsappUrl}" target="_blank" 
                               class="w-full bg-green-500 hover:bg-green-600 text-white p-3 rounded-xl flex items-center justify-center gap-2 transition-colors">
                                <i class="fab fa-whatsapp"></i>
                                <span>واتساب</span>
                            </a>
                            <a href="${twitterUrl}" target="_blank" 
                               class="w-full bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-xl flex items-center justify-center gap-2 transition-colors">
                                <i class="fab fa-twitter"></i>
                                <span>تويتر</span>
                            </a>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 p-3 rounded-xl transition-colors">
                                إلغاء
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            showComingSoon(buttonId, message) {
                const button = document.getElementById(buttonId);
                const originalHTML = button.innerHTML;
                
                button.innerHTML = '<i class="fas fa-clock text-lg sm:text-xl"></i><span>قريباً جداً!</span>';
                button.classList.remove('bg-primary');
                button.classList.add('bg-secondary');
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('bg-secondary');
                    button.classList.add('bg-primary');
                }, 2000);
            }

            showSuccess(buttonId, message) {
                const button = document.getElementById(buttonId);
                const originalHTML = button.innerHTML;
                
                button.innerHTML = '<i class="fas fa-check text-lg sm:text-xl"></i><span>تم النسخ!</span>';
                button.classList.add('bg-green-500');
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('bg-green-500');
                }, 2000);
            }

            showContent() {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
            }

            showError() {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
            }
        }

        // تهيئة الصفحة عند التحميل
        document.addEventListener('DOMContentLoaded', () => {
            window.branchPageManager = new BranchPageManager();
        });
    </script>
</body>
</html>
