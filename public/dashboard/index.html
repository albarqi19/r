<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ุงูุชุญูู - ุชุญููุธ ุงูุดุฑููุฉ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#494776',
                        secondary: '#4F9DA6',
                        custom: '#323266',
                        accent: '#7DCCE5'
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
    <style>
        .dashboard-card {
            transition: all 0.3s ease;
            border: 1px solid rgba(73, 71, 118, 0.1);
        }
        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 30px rgba(73, 71, 118, 0.1);
            border-color: rgba(73, 71, 118, 0.2);
        }
        .input-field {
            transition: all 0.3s ease;
        }
        .input-field:focus {
            border-color: #494776;
            box-shadow: 0 0 0 3px rgba(73, 71, 118, 0.1);
        }
        .status-pending {
            background: #f59e0b;
        }
        .status-approved {
            background: #10b981;
        }
        .status-rejected {
            background: #ef4444;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Header -->
    <nav class="bg-primary shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <!-- Logo & Title -->
                <div class="flex items-center gap-4">
                    <img src="../Logo.png" alt="ุชุญููุธ ุงูุดุฑููุฉ" class="w-12 h-12 object-contain">
                    <div>
                        <h1 class="text-white text-xl font-bold">ููุญุฉ ุงูุชุญูู</h1>
                        <p class="text-white/80 text-sm" id="branchTitle">ูุฑุน ุบุฑุจ ุงูุฏูุงู</p>
                    </div>
                </div>
                
                <!-- User Actions -->
                <div class="flex items-center gap-3">
                    <button id="previewBtn" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-sm transition-all">
                        <i class="fas fa-eye ml-2"></i>
                        ูุนุงููุฉ ุงูุตูุญุฉ
                    </button>
                    <button id="logoutBtn" class="bg-red-500/80 hover:bg-red-500 text-white px-4 py-2 rounded-lg text-sm transition-all">
                        <i class="fas fa-sign-out-alt ml-2"></i>
                        ุชุณุฌูู ุงูุฎุฑูุฌ
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        
        <!-- Status Alert -->
        <div id="statusAlert" class="mb-6 p-4 rounded-xl border-r-4 bg-blue-50 border-primary hidden">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-primary ml-3"></i>
                <div>
                    <h3 class="text-primary font-semibold">ุญุงูุฉ ุงูุชุญุฏูุซุงุช</h3>
                    <p class="text-gray-600 text-sm mt-1" id="statusMessage">ุฌููุน ุงูุจูุงูุงุช ูุญุฏุซุฉ</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Social Media Links -->
            <div class="lg:col-span-2">
                <div class="dashboard-card bg-white rounded-2xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-primary flex items-center gap-2">
                            <i class="fas fa-share-alt"></i>
                            ุฑูุงุจุท ุงูุชูุงุตู ุงูุงุฌุชูุงุนู
                        </h2>
                        <span class="status-approved text-white text-xs px-3 py-1 rounded-full">
                            ูุนุชูุฏ
                        </span>
                    </div>
                    
                    <form id="socialLinksForm" class="space-y-4">
                        
                        <!-- Twitter/X -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2 flex items-center gap-2">
                                <i class="fab fa-twitter text-blue-500"></i>
                                ุฑุงุจุท ุชููุชุฑ (X)
                            </label>
                            <input type="url" id="twitterUrl" 
                                   class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none"
                                   placeholder="https://x.com/username"
                                   value="https://x.com/Org2Qer">
                        </div>
                        
                        <!-- Instagram -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2 flex items-center gap-2">
                                <i class="fab fa-instagram text-pink-500"></i>
                                ุฑุงุจุท ุฅูุณุชุบุฑุงู
                            </label>
                            <input type="url" id="instagramUrl"
                                   class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none"
                                   placeholder="https://instagram.com/username"
                                   value="https://www.instagram.com/org2qer/">
                        </div>
                        
                        <!-- WhatsApp -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2 flex items-center gap-2">
                                <i class="fab fa-whatsapp text-green-500"></i>
                                ุฑูู ูุงุชุณุงุจ
                            </label>
                            <input type="tel" id="whatsappNumber"
                                   class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none"
                                   placeholder="966XXXXXXXXX"
                                   value="966138360356">
                            <p class="text-gray-500 text-xs mt-1">ุฃุฏุฎู ุงูุฑูู ุจุงูุตูุบุฉ ุงูุฏูููุฉ ุจุฏูู ุนูุงูุฉ +</p>
                        </div>
                        
                        <!-- Location -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-map-marker-alt text-red-500"></i>
                                ุฑุงุจุท ุงููููุน ุงูุฌุบุฑุงูู
                            </label>
                            <input type="url" id="locationUrl"
                                   class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none"
                                   placeholder="https://maps.google.com/..."
                                   value="https://maps.app.goo.gl/cFQHa1b2y3uoDbGy9">
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="pt-4">
                            <button type="submit" 
                                    class="btn-primary w-full flex items-center justify-center gap-2 py-3 text-base">
                                <i class="fas fa-save"></i>
                                <span>ุญูุธ ุงูุชุบููุฑุงุช</span>
                                <span id="saveSpinner" class="hidden">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </button>
                        </div>
                        
                    </form>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="space-y-6">
                
                <!-- Quick Stats -->
                <div class="dashboard-card bg-white rounded-2xl p-6 shadow-lg">
                    <h3 class="text-lg font-bold text-primary mb-4 flex items-center gap-2">
                        <i class="fas fa-chart-simple"></i>
                        ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ
                    </h3>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-600 text-sm">ุขุฎุฑ ุชุญุฏูุซ</span>
                            <span class="text-primary font-semibold text-sm">ููุฐ ููููู</span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-600 text-sm">ุญุงูุฉ ุงูุตูุญุฉ</span>
                            <span class="status-approved text-white text-xs px-2 py-1 rounded-full">ูุดุทุฉ</span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-600 text-sm">ุงูุชุบููุฑุงุช ุงููุนููุฉ</span>
                            <span class="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="dashboard-card bg-white rounded-2xl p-6 shadow-lg">
                    <h3 class="text-lg font-bold text-primary mb-4 flex items-center gap-2">
                        <i class="fas fa-bolt"></i>
                        ุฅุฌุฑุงุกุงุช ุณุฑูุนุฉ
                    </h3>
                    
                    <div class="space-y-3">
                        <button class="w-full text-right px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-xl transition-colors flex items-center gap-3">
                            <i class="fas fa-eye text-secondary"></i>
                            <span class="text-gray-700">ูุนุงููุฉ ุงูุตูุญุฉ</span>
                        </button>
                        
                        <button class="w-full text-right px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-xl transition-colors flex items-center gap-3">
                            <i class="fas fa-history text-secondary"></i>
                            <span class="text-gray-700">ุณุฌู ุงูุชุบููุฑุงุช</span>
                        </button>
                        
                        <button class="w-full text-right px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-xl transition-colors flex items-center gap-3">
                            <i class="fas fa-question-circle text-secondary"></i>
                            <span class="text-gray-700">ุงููุณุงุนุฏุฉ</span>
                        </button>
                    </div>
                </div>
                
                <!-- Support -->
                <div class="dashboard-card bg-secondary rounded-2xl p-6 shadow-lg text-white">
                    <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                        <i class="fas fa-headset"></i>
                        ุงูุฏุนู ุงูููู
                    </h3>
                    <p class="text-white/90 text-sm mb-4">
                        ูู ุชุญุชุงุฌ ูููุณุงุนุฏุฉุ ูุฑูู ุงูุฏุนู ูุชุงุญ ููุณุงุนุฏุชู
                    </p>
                    <button class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-sm transition-all w-full">
                        <i class="fas fa-comments ml-2"></i>
                        ุชูุงุตู ูุนูุง
                    </button>
                </div>
                
            </div>
            
        </div>
    </div>

    <!-- Scripts -->
    <script src="../assets/js/supabase-service.js"></script>
    <script src="../assets/js/app.js"></script>
    <script>
        class DashboardManager {
            constructor() {
                this.currentBranch = this.getBranchFromPath();
                this.init();
            }
            
            getBranchFromPath() {
                // ูุญุงููุฉ ุงุณุชุฎุฑุงุฌ ุงููุฑุน ูู URL ุฃู localStorage
                const urlParams = new URLSearchParams(window.location.search);
                const branchFromUrl = urlParams.get('branch');
                
                if (branchFromUrl) {
                    // ุญูุธ ูู localStorage ููุงุณุชุฎุฏุงู ุงููุณุชูุจูู
                    localStorage.setItem('currentBranch', branchFromUrl);
                    return branchFromUrl;
                }
                
                // ุงูุนูุฏุฉ ูููุญููุธ ูู localStorage ุฃู ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ
                const savedBranch = localStorage.getItem('currentBranch');
                return savedBranch || 'garb-dammam';
            }
            
            async init() {
                this.setupEventListeners();
                await this.loadBranchData();
                this.updateUI();
            }
            
            setupEventListeners() {
                // ุญูุธ ุงููููุฐุฌ
                document.getElementById('socialLinksForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveSocialLinks();
                });
                
                // ูุนุงููุฉ ุงูุตูุญุฉ
                document.getElementById('previewBtn').addEventListener('click', () => {
                    window.open(`../branches/${this.currentBranch}/`, '_blank');
                });
                
                // ุชุณุฌูู ุงูุฎุฑูุฌ
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    if (confirm('ูู ุชุฑูุฏ ุชุณุฌูู ุงูุฎุฑูุฌุ')) {
                        localStorage.removeItem('currentBranch');
                        localStorage.removeItem('userToken');
                        window.location.href = '../auth/login.html';
                    }
                });
            }
            
            async loadBranchData() {
                try {
                    console.log('๐ ุฌูุจ ุจูุงูุงุช ุงููุฑุน:', this.currentBranch);
                    
                    // ูุญุงููุฉ ุฌูุจ ุงูุจูุงูุงุช ูู Supabase ุฃููุงู
                    if (window.supabaseService && window.supabaseService.getBranch) {
                        const result = await window.supabaseService.getBranch(this.currentBranch);
                        if (result.success && result.data) {
                            console.log('โ ุชู ุฌูุจ ุงูุจูุงูุงุช ูู Supabase:', result.data);
                            this.branchData = result.data;
                            return;
                        }
                    }
                    
                    // Fallback ุฅูู branchManager
                    if (window.branchManager) {
                        console.log('๐ ุงุณุชุฎุฏุงู branchManager...');
                        this.branchData = await window.branchManager.loadBranchData(this.currentBranch);
                        return;
                    }
                    
                    // Fallback ุงูููุงุฆู - ุจูุงูุงุช ุงูุชุฑุงุถูุฉ
                    console.warn('โ๏ธ ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ');
                    this.branchData = {
                        id: this.currentBranch,
                        name: 'ุงููุฑุน',
                        twitter: '',
                        whatsapp: '',
                        instagram: '',
                        location: ''
                    };
                    
                } catch (error) {
                    console.error('โ ุฎุทุฃ ูู ุฌูุจ ุจูุงูุงุช ุงููุฑุน:', error);
                    this.branchData = {
                        id: this.currentBranch,
                        name: 'ุงููุฑุน',
                        twitter: '',
                        whatsapp: '',
                        instagram: '',
                        location: ''
                    };
                }
            }
            
            updateUI() {
                if (!this.branchData) return;
                
                // ุชุญุฏูุซ ุนููุงู ุงููุฑุน
                document.getElementById('branchTitle').textContent = `ูุฑุน ${this.branchData.name}`;
                
                // ุชุญุฏูุซ ุงูุญููู
                document.getElementById('twitterUrl').value = this.branchData.twitter || '';
                document.getElementById('instagramUrl').value = this.branchData.instagram || '';
                document.getElementById('whatsappNumber').value = this.branchData.whatsapp || '';
                document.getElementById('locationUrl').value = this.branchData.location || '';
            }
            
            async saveSocialLinks() {
                const submitBtn = document.querySelector('#socialLinksForm button[type="submit"]');
                const spinner = document.getElementById('saveSpinner');
                
                // ุฅุธูุงุฑ ุญุงูุฉ ุงูุชุญููู
                submitBtn.disabled = true;
                spinner.classList.remove('hidden');
                
                try {
                    // ุฌูุน ุงูุจูุงูุงุช
                    const formData = {
                        twitter: document.getElementById('twitterUrl').value,
                        instagram: document.getElementById('instagramUrl').value,
                        whatsapp: document.getElementById('whatsappNumber').value,
                        location: document.getElementById('locationUrl').value,
                        updatedAt: new Date().toISOString()
                    };
                    
                    // ูุญุงููุฉ ุงูุญูุธ ูู Supabase
                    if (!window.supabaseService || !window.supabaseService.createUpdateRequest) {
                        throw new Error('ุฎุฏูุฉ Supabase ุบูุฑ ูุชููุฑุฉ');
                    }
                    
                    console.log('๐ค ุฅุฑุณุงู ุทูุจ ุชุญุฏูุซ ูููุฑุงุฌุนุฉ...');
                    const result = await window.supabaseService.createUpdateRequest(
                        this.currentBranch, 
                        formData
                    );
                    
                    if (result.success) {
                        this.showNotification(
                            'ุชู ุฅุฑุณุงู ุทูุจ ุงูุชุญุฏูุซ ููุฅุฏุงุฑุฉ! ุณูุชู ุชุทุจูู ุงูุชุบููุฑุงุช ุจุนุฏ ุงูููุงููุฉ.',
                            'success'
                        );
                        
                        // ุชุญุฏูุซ ุญุงูุฉ ุงูุตูุญุฉ
                        this.updateStatusToPending();
                        
                        // ุชุณุฌูู ุงูุญุฏุซ ุฅุฐุง ูุงูุช ุงูุฏุงูุฉ ูุชููุฑุฉ
                        if (window.supabaseService.logEvent) {
                            window.supabaseService.logEvent('update_request_created', {
                                branch_id: this.currentBranch,
                                request_type: 'social_links'
                            });
                        }
                        
                        return;
                    } else {
                        throw new Error(result.error || 'ูุดู ูู ุฅูุดุงุก ุทูุจ ุงูุชุญุฏูุซ');
                    }
                    
                } catch (error) {
                    console.error('ุฎุทุฃ ูู ุงูุญูุธ:', error);
                    this.showNotification('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุจูุงูุงุช', 'error');
                } finally {
                    // ุฅุฎูุงุก ุญุงูุฉ ุงูุชุญููู
                    submitBtn.disabled = false;
                    spinner.classList.add('hidden');
                }
            }
            
            updateStatusToPending() {
                const statusElement = document.querySelector('.status-approved, .status-pending');
                if (statusElement) {
                    statusElement.className = 'status-pending text-white text-xs px-3 py-1 rounded-full';
                    statusElement.textContent = 'ูู ุงูุงูุชุธุงุฑ';
                }
            }
            
            showNotification(message, type = 'info') {
                if (window.utils) {
                    if (type === 'success') {
                        window.utils.showSuccess(message);
                    } else {
                        window.utils.showError(message);
                    }
                } else {
                    alert(message);
                }
            }
        }
        
        // ุชููุฆุฉ ููุญุฉ ุงูุชุญูู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('๐ ุชุญููู ููุญุฉ ุชุญูู ุงููุฑุน...');
            
            // ุงูุชุธุงุฑ ุชุญููู Supabase Service
            let retryCount = 0;
            const maxRetries = 10;
            
            const waitForSupabase = () => {
                return new Promise((resolve) => {
                    const checkSupabase = () => {
                        if (window.supabaseService && window.supabaseService.createUpdateRequest) {
                            console.log('โ ุชู ุงูุนุซูุฑ ุนูู Supabase Service');
                            resolve();
                            return;
                        }
                        
                        if (retryCount < maxRetries) {
                            retryCount++;
                            console.log(`โณ ูุญุงููุฉ ${retryCount}/${maxRetries} - ุงูุชุธุงุฑ Supabase Service...`);
                            setTimeout(checkSupabase, 500);
                        } else {
                            console.error('โ ูุดู ูู ุชุญููู Supabase Service');
                            resolve(); // ุงููุชุงุจุนุฉ ุญุชู ูู ูุดู
                        }
                    };
                    checkSupabase();
                });
            };
            
            await waitForSupabase();
            
            // ุชููุฆุฉ ููุญุฉ ุงูุชุญูู
            window.dashboardManager = new DashboardManager();
            console.log('โ ุชู ุชุญููู ููุญุฉ ุชุญูู ุงููุฑุน');
        });
    </script>
</body>
</html>
