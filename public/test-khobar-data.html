<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار بيانات فرع الخبر</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./assets/js/supabase-service.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'IBM Plex Sans Arabic', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-900">اختبار بيانات فرع الخبر</h1>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">حالة اتصال Supabase</h2>
            <div id="connectionStatus" class="text-gray-600">جاري فحص الاتصال...</div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">البيانات المسترجعة</h2>
            <div id="branchData" class="text-gray-600">جاري تحميل البيانات...</div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">تفاصيل تقنية</h2>
            <div id="technicalDetails" class="text-gray-600">جاري تحميل التفاصيل...</div>
        </div>

        <!-- Navigation -->
        <div class="text-center mt-8">
            <a href="./home.html" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors inline-flex items-center gap-2">
                <span>العودة للرئيسية</span>
            </a>
        </div>
    </div>

    <script>
        async function testKhobarData() {
            console.log('🔄 بدء اختبار بيانات فرع الخبر...');
            
            // فحص حالة اتصال Supabase
            const connectionDiv = document.getElementById('connectionStatus');
            const dataDiv = document.getElementById('branchData');
            const detailsDiv = document.getElementById('technicalDetails');
            
            try {
                connectionDiv.innerHTML = '<div class="text-yellow-600">⏳ انتظار تحميل خدمة Supabase...</div>';
                
                // انتظار تحميل خدمة Supabase
                let attempts = 0;
                while (!window.supabaseService && attempts < 50) {
                    console.log(`محاولة ${attempts + 1}: انتظار تحميل supabaseService...`);
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.supabaseService) {
                    connectionDiv.innerHTML = '<div class="text-red-600">❌ خدمة Supabase غير متوفرة بعد 5 ثوانِ</div>';
                    detailsDiv.innerHTML = '<div class="bg-red-50 p-4 rounded-lg">خطأ: لم يتم تحميل supabase-service.js</div>';
                    return;
                }
                
                connectionDiv.innerHTML = '<div class="text-green-600">✅ خدمة Supabase متوفرة</div>';
                console.log('✅ تم تحميل supabaseService:', typeof window.supabaseService);
                
                // فحص وجود دالة getBranch
                if (!window.supabaseService.getBranch) {
                    connectionDiv.innerHTML += '<div class="text-red-600 mt-2">❌ دالة getBranch غير متوفرة</div>';
                    detailsDiv.innerHTML = '<div class="bg-red-50 p-4 rounded-lg">خطأ: getBranch function not found</div>';
                    return;
                }
                
                connectionDiv.innerHTML += '<div class="text-green-600 mt-2">✅ دالة getBranch متوفرة</div>';
                
                // جلب بيانات فرع الخبر
                dataDiv.innerHTML = '<div class="text-yellow-600">⏳ جاري جلب بيانات فرع الخبر...</div>';
                console.log('🔍 جلب بيانات فرع khobar...');
                
                const result = await window.supabaseService.getBranch('khobar');
                console.log('📊 النتيجة:', result);
                
                if (result.success && result.data) {
                    dataDiv.innerHTML = `
                        <div class="text-green-600 mb-4">✅ تم جلب البيانات بنجاح</div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2">بيانات الفرع:</h3>
                            <ul class="space-y-2">
                                <li><strong>المعرف:</strong> ${result.data.branch_id || 'غير محدد'}</li>
                                <li><strong>الاسم:</strong> ${result.data.branch_name || 'غير محدد'}</li>
                                <li><strong>Twitter:</strong> ${result.data.twitter || 'غير محدد'}</li>
                                <li><strong>WhatsApp:</strong> ${result.data.whatsapp || 'غير محدد'}</li>
                                <li><strong>Instagram:</strong> ${result.data.instagram || 'غير محدد'}</li>
                                <li><strong>الموقع:</strong> ${result.data.location || 'غير محدد'}</li>
                                <li><strong>آخر تحديث:</strong> ${result.data.updated_at || 'غير محدد'}</li>
                            </ul>
                        </div>
                    `;
                    
                    detailsDiv.innerHTML = `
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2">البيانات الخام:</h3>
                            <pre class="text-xs overflow-x-auto bg-gray-800 text-green-400 p-3 rounded whitespace-pre-wrap">${JSON.stringify(result.data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    dataDiv.innerHTML = `
                        <div class="text-red-600 mb-4">❌ فشل في جلب البيانات</div>
                        <div class="text-gray-600 mt-2">السبب: ${result.error || result.message || 'غير معروف'}</div>
                    `;
                    
                    detailsDiv.innerHTML = `
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2">تفاصيل الخطأ:</h3>
                            <pre class="text-xs overflow-x-auto bg-red-100 text-red-800 p-3 rounded whitespace-pre-wrap">${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('❌ خطأ في الاختبار:', error);
                connectionDiv.innerHTML = '<div class="text-red-600">❌ حدث خطأ في الاتصال</div>';
                dataDiv.innerHTML = `<div class="text-red-600">خطأ: ${error.message}</div>`;
                detailsDiv.innerHTML = `
                    <div class="bg-red-50 p-4 rounded-lg">
                        <h3 class="font-semibold mb-2">تفاصيل الخطأ:</h3>
                        <pre class="text-xs overflow-x-auto bg-red-100 text-red-800 p-3 rounded whitespace-pre-wrap">${error.stack}</pre>
                    </div>
                `;
            }
        }
        
        // التأكد من تحميل DOM أولاً
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', testKhobarData);
        } else {
            // DOM already loaded
            testKhobarData();
        }
        
        // Fallback: تشغيل الاختبار بعد ثانيتين في جميع الأحوال
        setTimeout(testKhobarData, 2000);
    </script>
</body>
</html>
