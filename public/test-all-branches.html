<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فحص جميع الفروع</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./assets/js/supabase-service.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'IBM Plex Sans Arabic', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-900">فحص جميع الفروع في قاعدة البيانات</h1>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">حالة النظام</h2>
            <div id="systemStatus" class="text-gray-600">جاري فحص النظام...</div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">اختبار فرع الخبر (khobar)</h2>
            <div id="khobarTest" class="text-gray-600">جاري الاختبار...</div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">جميع الفروع المتاحة</h2>
            <div id="allBranches" class="text-gray-600">جاري تحميل قائمة الفروع...</div>
        </div>

        <!-- Navigation -->
        <div class="text-center mt-8">
            <a href="./home.html" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors inline-flex items-center gap-2 mx-2">
                العودة للرئيسية
            </a>
            <a href="./branch-template.html?branch=khobar" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors inline-flex items-center gap-2 mx-2">
                اختبار صفحة الخبر
            </a>
        </div>
    </div>

    <script>
        async function testAllBranches() {
            console.log('🔄 بدء فحص جميع الفروع...');
            
            const systemDiv = document.getElementById('systemStatus');
            const khobarDiv = document.getElementById('khobarTest');
            const allBranchesDiv = document.getElementById('allBranches');
            
            try {
                // فحص حالة النظام
                systemDiv.innerHTML = '<div class="text-yellow-600">⏳ انتظار تحميل خدمة Supabase...</div>';
                
                let attempts = 0;
                while (!window.supabaseService && attempts < 50) {
                    console.log(`محاولة ${attempts + 1}: انتظار تحميل supabaseService...`);
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.supabaseService) {
                    systemDiv.innerHTML = '<div class="text-red-600">❌ خدمة Supabase غير متوفرة</div>';
                    return;
                }
                
                systemDiv.innerHTML = '<div class="text-green-600">✅ خدمة Supabase متوفرة</div>';
                
                // فحص الدوال المتاحة
                const availableFunctions = Object.keys(window.supabaseService).filter(key => typeof window.supabaseService[key] === 'function');
                systemDiv.innerHTML += `<div class="text-blue-600 mt-2">📋 الدوال المتاحة: ${availableFunctions.join(', ')}</div>`;
                
                // اختبار فرع الخبر
                khobarDiv.innerHTML = '<div class="text-yellow-600">⏳ جاري اختبار فرع الخبر...</div>';
                
                if (window.supabaseService.getBranch) {
                    const khobarResult = await window.supabaseService.getBranch('khobar');
                    console.log('📊 نتيجة اختبار الخبر:', khobarResult);
                    
                    if (khobarResult.success && khobarResult.data) {
                        khobarDiv.innerHTML = `
                            <div class="text-green-600 mb-2">✅ تم العثور على فرع الخبر</div>
                            <div class="bg-green-50 p-3 rounded">
                                <strong>الاسم:</strong> ${khobarResult.data.name || khobarResult.data.branch_name || 'غير محدد'}<br>
                                <strong>المعرف:</strong> ${khobarResult.data.id || khobarResult.data.branch_id || 'غير محدد'}<br>
                                <strong>Twitter:</strong> ${khobarResult.data.twitter || 'غير محدد'}<br>
                                <strong>WhatsApp:</strong> ${khobarResult.data.whatsapp || 'غير محدد'}
                            </div>
                        `;
                    } else {
                        khobarDiv.innerHTML = `
                            <div class="text-red-600 mb-2">❌ لم يتم العثور على فرع الخبر</div>
                            <div class="bg-red-50 p-3 rounded text-sm">
                                <strong>تفاصيل الخطأ:</strong><br>
                                <pre>${JSON.stringify(khobarResult, null, 2)}</pre>
                            </div>
                        `;
                    }
                } else {
                    khobarDiv.innerHTML = '<div class="text-red-600">❌ دالة getBranch غير متوفرة</div>';
                }
                
                // جلب جميع الفروع
                allBranchesDiv.innerHTML = '<div class="text-yellow-600">⏳ جاري جلب جميع الفروع...</div>';
                
                if (window.supabaseService.getAllBranches) {
                    const allBranchesResult = await window.supabaseService.getAllBranches();
                    console.log('📊 نتيجة جلب جميع الفروع:', allBranchesResult);
                    
                    if (allBranchesResult.success && allBranchesResult.data) {
                        const branches = allBranchesResult.data;
                        let branchesHtml = `<div class="text-green-600 mb-4">✅ تم العثور على ${branches.length} فرع</div>`;
                        branchesHtml += '<div class="grid gap-4">';
                        
                        branches.forEach(branch => {
                            branchesHtml += `
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <div class="font-bold text-lg">${branch.name || branch.branch_name || 'اسم غير محدد'}</div>
                                    <div class="text-sm text-gray-600">المعرف: ${branch.id || branch.branch_id || 'معرف غير محدد'}</div>
                                    <div class="text-sm text-gray-600">آخر تحديث: ${branch.updated_at || 'غير محدد'}</div>
                                    <a href="./branch-template.html?branch=${branch.id || branch.branch_id}" 
                                       class="inline-block mt-2 bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                       اختبار الصفحة
                                    </a>
                                </div>
                            `;
                        });
                        
                        branchesHtml += '</div>';
                        allBranchesDiv.innerHTML = branchesHtml;
                    } else {
                        allBranchesDiv.innerHTML = `
                            <div class="text-red-600 mb-2">❌ فشل في جلب قائمة الفروع</div>
                            <div class="bg-red-50 p-3 rounded text-sm">
                                <pre>${JSON.stringify(allBranchesResult, null, 2)}</pre>
                            </div>
                        `;
                    }
                } else {
                    allBranchesDiv.innerHTML = '<div class="text-red-600">❌ دالة getAllBranches غير متوفرة</div>';
                }
                
            } catch (error) {
                console.error('❌ خطأ في الفحص:', error);
                systemDiv.innerHTML = '<div class="text-red-600">❌ حدث خطأ في النظام</div>';
                allBranchesDiv.innerHTML = `
                    <div class="text-red-600 mb-2">❌ خطأ في جلب البيانات</div>
                    <div class="bg-red-50 p-3 rounded text-sm">
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }
        
        // بدء الفحص عند تحميل الصفحة
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', testAllBranches);
        } else {
            testAllBranches();
        }
    </script>
</body>
</html>
